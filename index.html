<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Library</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f7f3e9 0%, #e8dcc0 50%, #d4c5a9 100%);
            min-height: 100vh;
            color: #5d4e37;
        }

        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f7f3e9 0%, #e8dcc0 50%, #d4c5a9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-box {
            background: rgba(248, 246, 240, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(139, 125, 107, 0.3);
            border: 1px solid rgba(196, 181, 153, 0.3);
        }

        .auth-box h2 {
            color: #5d4e37;
            margin-bottom: 20px;
            font-weight: 400;
            font-size: 2rem;
        }

        .auth-box p {
            color: #6b5b73;
            margin-bottom: 30px;
            font-style: italic;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        .container.show {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #6b5b73;
            position: relative;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(139, 125, 107, 0.2);
            font-weight: 400;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.8;
            font-style: italic;
        }

        .user-info {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(248, 246, 240, 0.9);
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            color: #6b5b73;
        }

        .logout-btn {
            background: #d4c5a9;
            color: #5d4e37;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8rem;
        }

        .controls {
            background: rgba(248, 246, 240, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(139, 125, 107, 0.15);
            border: 1px solid rgba(196, 181, 153, 0.3);
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        input, select, button {
            padding: 12px 16px;
            border: 2px solid #c4b599;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8b7d6b;
            box-shadow: 0 0 0 3px rgba(139, 125, 107, 0.1);
        }

        button {
            background: linear-gradient(135deg, #8b7d6b, #6b5b73);
            color: #f8f6f0;
            border: none;
            cursor: pointer;
            font-weight: 500;
            text-transform: lowercase;
            letter-spacing: 1px;
            border-radius: 25px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 125, 107, 0.3);
            background: linear-gradient(135deg, #6b5b73, #8b7d6b);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .add-btn {
            background: linear-gradient(135deg, #7a6b54, #9c8b7a);
        }

        .search-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .product-card {
            background: #faf8f3;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(139, 125, 107, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(196, 181, 153, 0.2);
            display: flex;
            flex-direction: column;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f0ede6;
            border: 2px dashed rgba(196, 181, 153, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8a7968;
            font-style: italic;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-image.no-image {
            background: linear-gradient(135deg, #f0ede6, #e8dcc0);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #8b7d6b, #6b5b73);
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 125, 107, 0.2);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .product-title {
            font-size: 1.4rem;
            font-weight: 500;
            color: #5d4e37;
            margin-bottom: 5px;
        }

        .product-category {
            background: linear-gradient(135deg, #a08b72, #8b7d6b);
            color: #f8f6f0;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 400;
            font-style: italic;
        }

        .product-details {
            margin-bottom: 20px;
        }

        .product-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(196, 181, 153, 0.3);
        }

        .product-detail:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #6b5b73;
        }

        .detail-value {
            color: #5d4e37;
        }

        .product-description {
            color: #8a7968;
            line-height: 1.6;
            margin-bottom: 20px;
            font-style: italic;
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #9c8b7a, #a08b72);
            font-size: 14px;
            padding: 8px 16px;
        }

        .delete-btn {
            background: linear-gradient(135deg, #8b6b6b, #7a5a5a);
            font-size: 14px;
            padding: 8px 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(93, 78, 55, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #faf8f3;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(139, 125, 107, 0.3);
            border: 1px solid rgba(196, 181, 153, 0.3);
        }

        .modal-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .modal-header h2 {
            color: #5d4e37;
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #6b5b73;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }

        .image-upload {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 2px dashed #c4b599;
            border-radius: 8px;
            background: #f8f6f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload:hover {
            border-color: #8b7d6b;
            background: #f0ede6;
        }

        .image-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .image-upload-content {
            text-align: center;
            pointer-events: none;
        }

        .upload-icon {
            font-size: 2rem;
            color: #8a7968;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #6b5b73;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: #8a7968;
            font-size: 0.8rem;
            font-style: italic;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .remove-image {
            background: #8b6b6b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-top: 10px;
            cursor: pointer;
        }

        .file-upload {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 2px dashed #c4b599;
            border-radius: 8px;
            background: #f8f6f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #8b7d6b;
            background: #f0ede6;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-content {
            text-align: center;
            pointer-events: none;
        }

        .file-icon {
            font-size: 1.5rem;
            color: #8a7968;
            margin-bottom: 8px;
        }

        .file-text {
            color: #6b5b73;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .file-hint {
            color: #8a7968;
            font-size: 0.75rem;
            font-style: italic;
        }

        .attached-file {
            background: rgba(139, 125, 107, 0.1);
            border: 1px solid rgba(196, 181, 153, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-name {
            color: #5d4e37;
            font-size: 0.9rem;
        }

        .remove-file {
            background: #8b6b6b;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .labels-input {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            min-height: 40px;
            padding: 8px;
            border: 2px solid #c4b599;
            border-radius: 8px;
            background: white;
            cursor: text;
        }

        .labels-input:focus-within {
            border-color: #8b7d6b;
            box-shadow: 0 0 0 3px rgba(139, 125, 107, 0.1);
        }

        .label-tag {
            background: linear-gradient(135deg, #a08b72, #8b7d6b);
            color: #f8f6f0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-label {
            background: none;
            border: none;
            color: #f8f6f0;
            cursor: pointer;
            padding: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .labels-input input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            padding: 4px;
            background: transparent;
            font-family: 'Georgia', serif;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .product-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }

        .product-detail-full {
            grid-column: 1 / -1;
        }

        .product-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .product-label {
            background: linear-gradient(135deg, #a08b72, #8b7d6b);
            color: #f8f6f0;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .product-notes {
            background: rgba(139, 125, 107, 0.05);
            border-left: 3px solid #a08b72;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-style: italic;
            color: #6b5b73;
        }

        .product-attachment {
            background: rgba(139, 125, 107, 0.1);
            border: 1px solid rgba(196, 181, 153, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attachment-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #5d4e37;
            font-size: 0.9rem;
        }

        .download-btn {
            background: linear-gradient(135deg, #7a6b54, #9c8b7a);
            color: #f8f6f0;
            border: none;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        .consumable-indicator {
            background: linear-gradient(135deg, #e8a87c, #c27d38);
            color: #f8f6f0;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .cancel-btn {
            background: #d4c5a9;
            color: #5d4e37;
        }

        .stats {
            background: rgba(248, 246, 240, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(139, 125, 107, 0.15);
            border: 1px solid rgba(196, 181, 153, 0.3);
        }

        .stats h3 {
            color: #5d4e37;
            margin-bottom: 10px;
            font-size: 1.3rem;
            font-weight: 400;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #8b7d6b, #a08b72);
            color: #f8f6f0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b5b73;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            opacity: 0.8;
            font-weight: 400;
        }

        .empty-state p {
            opacity: 0.6;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b5b73;
        }

        .error {
            background: rgba(255, 200, 200, 0.9);
            color: #8b0000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(248, 246, 240, 0.95);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #6b5b73;
            z-index: 100;
        }

        .sync-status.syncing {
            background: rgba(255, 243, 205, 0.95);
        }

        .sync-status.error {
            background: rgba(255, 200, 200, 0.95);
            color: #8b0000;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-row {
                flex-direction: column;
            }
            
            .search-section,
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h2>Welcome to Your Product Library</h2>
            <p>Please sign in to access your products from any device</p>
            <button onclick="signInWithGoogle()" id="signInBtn">sign in with google</button>
            <div id="authError" class="error" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <div class="sync-status" id="syncStatus" style="display: none;">● synced</div>

    <div class="container" id="mainContainer">
        <div class="header">
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button onclick="signOut()" class="logout-btn">sign out</button>
            </div>
            <h1>Product Library</h1>
            <p>Manage and organize your products with style</p>
        </div>

        <div id="errorContainer"></div>

        <div class="controls">
            <div class="control-row">
                <div class="search-section">
                    <input type="text" id="searchInput" placeholder="Search products..." class="search-input">
                    <button onclick="clearSearch()">clear</button>
                </div>
            </div>
            
            <div class="control-row">
                <div class="filter-section">
                    <select id="categoryFilter">
                        <option value="">all categories</option>
                    </select>
                    <select id="sortBy">
                        <option value="name">sort by name</option>
                        <option value="category">sort by category</option>
                        <option value="price">sort by price</option>
                        <option value="date">sort by date added</option>
                    </select>
                    <button onclick="openModal()" class="add-btn">add product</button>
                </div>
            </div>
        </div>

        <div id="loadingContainer" class="loading">
            <p>loading your products...</p>
        </div>

        <div id="productsContainer" class="products-grid" style="display: none;"></div>

        <div class="stats" id="statsContainer" style="display: none;">
            <h3>library statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div class="stat-label">total products</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCategories">0</div>
                    <div class="stat-label">categories</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalValue">$0</div>
                    <div class="stat-label">total value</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">add new product</h2>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">item name *</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productBrand">brand</label>
                        <input type="text" id="productBrand">
                    </div>
                    
                    <div class="form-group">
                        <label for="productSku">sku</label>
                        <input type="text" id="productSku">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">item description</label>
                    <textarea id="productDescription" placeholder="detailed product description..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productNotes">notes for myself</label>
                    <textarea id="productNotes" placeholder="private notes, reminders, thoughts..."></textarea>
                </div>

                <div class="form-group">
                    <label for="productUrl">item url</label>
                    <input type="url" id="productUrl" placeholder="https://example.com/product">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productOriginalPrice">original price</label>
                        <input type="number" id="productOriginalPrice" step="0.01" min="0" placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="productPricePaid">price paid</label>
                        <input type="number" id="productPricePaid" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="productStock">stock quantity</label>
                    <input type="number" id="productStock" min="0" placeholder="0">
                </div>

                <div class="form-group">
                    <label>labels</label>
                    <div class="labels-input" onclick="focusLabelInput()">
                        <div id="labelTags"></div>
                        <input type="text" id="labelInput" placeholder="add labels..." onkeydown="handleLabelInput(event)" onblur="addCurrentLabel()">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="productConsumable">
                    <label for="productConsumable">consumable item</label>
                </div>
                
                <div class="form-group">
                    <label for="productImage">product image</label>
                    <div class="image-upload" onclick="document.getElementById('productImage').click()">
                        <input type="file" id="productImage" accept="image/*" onchange="handleImageSelect(event)">
                        <div class="image-upload-content" id="uploadContent">
                            <div class="upload-icon">📷</div>
                            <div class="upload-text">click to add product image</div>
                            <div class="upload-hint">jpg, png, gif up to 5mb</div>
                        </div>
                        <img id="imagePreview" class="image-preview" style="display: none;">
                        <button type="button" id="removeImageBtn" class="remove-image" style="display: none;" onclick="removeImage(event)">remove image</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productAttachment">product attachment</label>
                    <div class="file-upload" onclick="document.getElementById('productAttachment').click()">
                        <input type="file" id="productAttachment" accept=".pdf,.doc,.docx,.txt,.xlsx,.xls" onchange="handleFileSelect(event)">
                        <div class="file-upload-content" id="fileUploadContent">
                            <div class="file-icon">📎</div>
                            <div class="file-text">click to attach file</div>
                            <div class="file-hint">pdf, doc, xlsx, txt up to 10mb</div>
                        </div>
                    </div>
                    <div id="attachedFile" class="attached-file" style="display: none;">
                        <div class="file-info">
                            <span>📎</span>
                            <span class="file-name" id="fileName"></span>
                        </div>
                        <button type="button" class="remove-file" onclick="removeFile(event)">remove</button>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" onclick="closeModal()" class="cancel-btn">cancel</button>
                    <button type="submit" id="submitBtn">add product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration - YOU NEED TO REPLACE THIS WITH YOUR OWN CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyD88b3EXr5Sc5MK1n1iadUeFDTqyxhpaAs",
          authDomain: "possessions-988a8.firebaseapp.com",
          projectId: "possessions-988a8",
          storageBucket: "possessions-988a8.firebasestorage.app",
          messagingSenderId: "170290770064",
          appId: "1:170290770064:web:2bc3c9f6e8706e1994a815",
          measurementId: "G-CBK7S6Q8RS"
        };

        // Initialize Firebase
        let app, auth, db, storage, currentUser = null;
        let products = [];
        let editingId = null;
        let selectedImageFile = null;
        let selectedAttachmentFile = null;
        let currentLabels = [];

        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase config is set
            if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                showAuthError('Firebase configuration needed. Please follow the setup instructions.');
                document.getElementById('setupInstructions').style.display = 'block';
                return;
            }

            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();

                console.log('Firebase initialized successfully');

                // Auth state listener
                auth.onAuthStateChanged(user => {
                    console.log('Auth state changed:', user ? 'signed in' : 'signed out');
                    if (user) {
                        currentUser = user;
                        showMainApp();
                        loadProducts();
                    } else {
                        currentUser = null;
                        showAuthScreen();
                    }
                });
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showAuthError('Firebase setup error: ' + error.message + '. Please check your configuration.');
                document.getElementById('setupInstructions').style.display = 'block';
            }
        });

        // Authentication functions
        function signInWithGoogle() {
            const signInBtn = document.getElementById('signInBtn');
            signInBtn.disabled = true;
            signInBtn.textContent = 'signing in...';
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            auth.signInWithPopup(provider).then(result => {
                // Success - auth state listener will handle the rest
                console.log('Sign in successful');
            }).catch(error => {
                console.error('Sign in error:', error);
                signInBtn.disabled = false;
                signInBtn.textContent = 'sign in with google';
                
                let errorMessage = 'Sign in failed: ';
                switch(error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage += 'Sign in was cancelled';
                        break;
                    case 'auth/popup-blocked':
                        errorMessage += 'Popup was blocked by browser. Please allow popups and try again';
                        break;
                    case 'auth/unauthorized-domain':
                        errorMessage += 'This domain is not authorized. Please add it to Firebase Authentication settings';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage += 'Google sign-in is not enabled. Please enable it in Firebase console';
                        break;
                    default:
                        errorMessage += error.message;
                }
                showAuthError(errorMessage);
            });
        }

        function signOut() {
            auth.signOut();
        }

        function showAuthScreen() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContainer').classList.remove('show');
            
            // Reset sign in button
            const signInBtn = document.getElementById('signInBtn');
            signInBtn.disabled = false;
            signInBtn.textContent = 'sign in with google';
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('show');
            document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
            document.getElementById('userInfo').style.display = 'block';
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // File handling functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    return;
                }

                selectedAttachmentFile = file;
                
                // Show file info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('attachedFile').style.display = 'flex';
                document.getElementById('fileUploadContent').style.display = 'none';
            }
        }

        function removeFile(event) {
            event.stopPropagation();
            selectedAttachmentFile = null;
            
            document.getElementById('attachedFile').style.display = 'none';
            document.getElementById('fileUploadContent').style.display = 'block';
            document.getElementById('productAttachment').value = '';
        }

        // Label handling functions
        function focusLabelInput() {
            document.getElementById('labelInput').focus();
        }

        function handleLabelInput(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                addCurrentLabel();
            } else if (event.key === 'Backspace' && event.target.value === '' && currentLabels.length > 0) {
                removeLabel(currentLabels.length - 1);
            }
        }

        function addCurrentLabel() {
            const input = document.getElementById('labelInput');
            const value = input.value.trim();
            
            if (value && !currentLabels.includes(value)) {
                currentLabels.push(value);
                input.value = '';
                renderLabels();
            }
        }

        function removeLabel(index) {
            currentLabels.splice(index, 1);
            renderLabels();
        }

        function renderLabels() {
            const container = document.getElementById('labelTags');
            container.innerHTML = currentLabels.map((label, index) => `
                <div class="label-tag">
                    ${label}
                    <button type="button" class="remove-label" onclick="removeLabel(${index})">×</button>
                </div>
            `).join('');
        }
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    return;
                }

                selectedImageFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const content = document.getElementById('uploadContent');
                    const removeBtn = document.getElementById('removeImageBtn');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    content.style.display = 'none';
                    removeBtn.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(event) {
            event.stopPropagation();
            selectedImageFile = null;
            
            const preview = document.getElementById('imagePreview');
            const content = document.getElementById('uploadContent');
            const removeBtn = document.getElementById('removeImageBtn');
            const fileInput = document.getElementById('productImage');
            
            preview.style.display = 'none';
            content.style.display = 'block';
            removeBtn.style.display = 'none';
            fileInput.value = '';
        }

        // Upload file to Firebase Storage
        async function uploadFile(file, productId, fileType = 'attachment') {
            if (!file) return null;
            
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`users/${currentUser.uid}/products/${productId}/${fileType}s/${file.name}`);
            
            try {
                const snapshot = await fileRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                return {
                    url: downloadURL,
                    name: file.name,
                    size: file.size,
                    type: file.type
                };
            } catch (error) {
                console.error(`${fileType} upload failed:`, error);
                throw error;
            }
        }

        // Delete file from Firebase Storage
        async function deleteFile(fileUrl) {
            if (!fileUrl) return;
            
            try {
                const fileRef = storage.refFromURL(fileUrl);
                await fileRef.delete();
            } catch (error) {
                console.error('File deletion failed:', error);
            }
        }
        function getProductsCollection() {
            return db.collection('users').doc(currentUser.uid).collection('products');
        }

        function showSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.style.display = 'block';
            syncStatus.className = 'sync-status';
            
            switch(status) {
                case 'syncing':
                    syncStatus.textContent = '● syncing...';
                    syncStatus.classList.add('syncing');
                    break;
                case 'synced':
                    syncStatus.textContent = '● synced';
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                    }, 2000);
                    break;
                case 'error':
                    syncStatus.textContent = '● sync error';
                    syncStatus.classList.add('error');
                    break;
            }
        }

        // Load products from Firestore
        function loadProducts() {
            if (!currentUser) return;

            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('productsContainer').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';

            getProductsCollection().orderBy('dateAdded', 'desc').onSnapshot(snapshot => {
                products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('productsContainer').style.display = 'grid';
                document.getElementById('statsContainer').style.display = 'block';
                
                renderProducts();
                updateStats();
                updateCategoryFilter();
                showSyncStatus('synced');
            }, error => {
                showError('Failed to load products: ' + error.message);
                showSyncStatus('error');
            });
        }

        // Save product to Firestore
        async function saveProduct(productData) {
            if (!currentUser) return;

            showSyncStatus('syncing');
            
            try {
                let imageUrl = null;
                let attachmentData = null;
                
                const tempId = editingId || Date.now().toString();
                
                // Handle image upload
                if (selectedImageFile) {
                    const imageInfo = await uploadFile(selectedImageFile, tempId, 'image');
                    imageUrl = imageInfo.url;
                    selectedImageFile = null;
                }

                // Handle attachment upload
                if (selectedAttachmentFile) {
                    attachmentData = await uploadFile(selectedAttachmentFile, tempId, 'attachment');
                    selectedAttachmentFile = null;
                }

                if (editingId !== null) {
                    // Update existing product
                    const updateData = {
                        ...productData,
                        labels: currentLabels,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Only update files if new ones were uploaded
                    if (imageUrl) {
                        const oldProduct = products.find(p => p.id === editingId);
                        if (oldProduct && oldProduct.imageUrl) {
                            await deleteFile(oldProduct.imageUrl);
                        }
                        updateData.imageUrl = imageUrl;
                    }
                    
                    if (attachmentData) {
                        const oldProduct = products.find(p => p.id === editingId);
                        if (oldProduct && oldProduct.attachment) {
                            await deleteFile(oldProduct.attachment.url);
                        }
                        updateData.attachment = attachmentData;
                    }
                    
                    await getProductsCollection().doc(editingId).update(updateData);
                    editingId = null;
                } else {
                    // Add new product
                    const newProductData = {
                        ...productData,
                        labels: currentLabels,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (imageUrl) {
                        newProductData.imageUrl = imageUrl;
                    }
                    
                    if (attachmentData) {
                        newProductData.attachment = attachmentData;
                    }
                    
                    await getProductsCollection().add(newProductData);
                }
            } catch (error) {
                showError('Failed to save product: ' + error.message);
                showSyncStatus('error');
            }
        }

        // Delete product from Firestore
        async function deleteProduct(id) {
            if (!currentUser) return;
            if (!confirm('Are you sure you want to delete this product?')) return;

            showSyncStatus('syncing');
            
            try {
                // Delete associated files first
                const product = products.find(p => p.id === id);
                if (product) {
                    if (product.imageUrl) {
                        await deleteFile(product.imageUrl);
                    }
                    if (product.attachment) {
                        await deleteFile(product.attachment.url);
                    }
                }
                
                await getProductsCollection().doc(id).delete();
            } catch (error) {
                showError('Failed to delete product: ' + error.message);
                showSyncStatus('error');
            }
        }

        // UI functions (same as before but adapted for Firebase)
        function openModal(product = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtn');

            // Reset all form areas
            removeImage({ stopPropagation: () => {} });
            removeFile({ stopPropagation: () => {} });
            currentLabels = [];
            renderLabels();

            if (product) {
                editingId = product.id;
                title.textContent = 'edit product';
                submitBtn.textContent = 'update product';
                
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productBrand').value = product.brand || '';
                document.getElementById('productSku').value = product.sku || '';
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productNotes').value = product.notes || '';
                document.getElementById('productUrl').value = product.url || '';
                document.getElementById('productOriginalPrice').value = product.originalPrice || '';
                document.getElementById('productPricePaid').value = product.pricePaid || '';
                document.getElementById('productStock').value = product.stock || '';
                document.getElementById('productConsumable').checked = product.consumable || false;
                
                // Set labels
                currentLabels = product.labels || [];
                renderLabels();
                
                // Show existing image if available
                if (product.imageUrl) {
                    const preview = document.getElementById('imagePreview');
                    const content = document.getElementById('uploadContent');
                    const removeBtn = document.getElementById('removeImageBtn');
                    
                    preview.src = product.imageUrl;
                    preview.style.display = 'block';
                    content.style.display = 'none';
                    removeBtn.style.display = 'block';
                }

                // Show existing attachment if available
                if (product.attachment) {
                    document.getElementById('fileName').textContent = product.attachment.name;
                    document.getElementById('attachedFile').style.display = 'flex';
                    document.getElementById('fileUploadContent').style.display = 'none';
                }
            } else {
                editingId = null;
                title.textContent = 'add new product';
                submitBtn.textContent = 'add product';
                form.reset();
            }

            modal.style.display = 'block';
        }Content = 'edit product';
                submitBtn.textContent = 'update product';
                
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productPrice').value = product.price || '';
                document.getElementById('productSku').value = product.sku || '';
                document.getElementById('productStock').value = product.stock || '';
                document.getElementById('productDescription').value = product.description || '';
                
                // Show existing image if available
                if (product.imageUrl) {
                    const preview = document.getElementById('imagePreview');
                    const content = document.getElementById('uploadContent');
                    const removeBtn = document.getElementById('removeImageBtn');
                    
                    preview.src = product.imageUrl;
                    preview.style.display = 'block';
                    content.style.display = 'none';
                    removeBtn.style.display = 'block';
                }
            } else {
                editingId = null;
                title.textContent = 'add new product';
                submitBtn.textContent = 'add product';
                form.reset();
            }

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            document.getElementById('productForm').reset();
            removeImage({ stopPropagation: () => {} });
            removeFile({ stopPropagation: () => {} });
            currentLabels = [];
            renderLabels();
            editingId = null;
        }

        // Handle form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                sku: document.getElementById('productSku').value,
                description: document.getElementById('productDescription').value,
                notes: document.getElementById('productNotes').value,
                url: document.getElementById('productUrl').value,
                originalPrice: parseFloat(document.getElementById('productOriginalPrice').value) || 0,
                pricePaid: parseFloat(document.getElementById('productPricePaid').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                consumable: document.getElementById('productConsumable').checked
            };

            saveProduct(productData);
            closeModal();
        });

        // Render products (same logic as before)
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filteredProducts = products.filter(product => {
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });

            // Sort products
            filteredProducts.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'category':
                        return a.category.localeCompare(b.category);
                    case 'price':
                        return (b.price || 0) - (a.price || 0);
                    case 'date':
                        if (a.dateAdded && b.dateAdded) {
                            return b.dateAdded.seconds - a.dateAdded.seconds;
                        }
                        return 0;
                    default:
                        return 0;
                }
            });

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>no products found</h3>
                        <p>try adjusting your search or filters, or add your first product!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    ${product.imageUrl ? 
                        `<div class="product-image">
                            <img src="${product.imageUrl}" alt="${product.name}" loading="lazy">
                         </div>` : 
                        `<div class="product-image no-image">
                            📷 no image
                         </div>`
                    }
                    
                    <div class="product-header">
                        <div>
                            <div class="product-title">${product.name}</div>
                        </div>
                        <div class="product-category">${product.category}</div>
                    </div>
                    
                    <div class="product-details">
                        ${product.price ? `
                            <div class="product-detail">
                                <span class="detail-label">price:</span>
                                <span class="detail-value">${product.price.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        ${product.sku ? `
                            <div class="product-detail">
                                <span class="detail-label">sku:</span>
                                <span class="detail-value">${product.sku}</span>
                            </div>
                        ` : ''}
                        ${product.stock !== undefined ? `
                            <div class="product-detail">
                                <span class="detail-label">stock:</span>
                                <span class="detail-value">${product.stock} units</span>
                            </div>
                        ` : ''}
                        <div class="product-detail">
                            <span class="detail-label">added:</span>
                            <span class="detail-value">${product.dateAdded ? new Date(product.dateAdded.seconds * 1000).toLocaleDateString() : 'unknown'}</span>
                        </div>
                    </div>
                    
                    ${product.description ? `
                        <div class="product-description">${product.description}</div>
                    ` : ''}
                    
                    <div class="product-actions">
                        <button onclick="openModal(${JSON.stringify(product).replace(/"/g, '&quot;')})" class="edit-btn">edit</button>
                        <button onclick="deleteProduct('${product.id}')" class="delete-btn">delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats() {
            const totalProducts = products.length;
            const categories = [...new Set(products.map(p => p.category))].length;
            const totalValue = products.reduce((sum, p) => sum + (p.price || 0), 0);

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalCategories').textContent = categories;
            document.getElementById('totalValue').textContent = `${totalValue.toFixed(2)}`;
        }

        // Update category filter dropdown
        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const allLabels = [];
            
            products.forEach(product => {
                if (product.labels) {
                    allLabels.push(...product.labels);
                }
            });
            
            const uniqueLabels = [...new Set(allLabels)].sort();
            
            const currentValue = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">all categories</option>';
            
            uniqueLabels.forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                option.textContent = label;
                categoryFilter.appendChild(option);
            });
            
            categoryFilter.value = currentValue;
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            renderProducts();
        }

        // Error handling
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderProducts);
        document.getElementById('categoryFilter').addEventListener('change', renderProducts);
        document.getElementById('sortBy').addEventListener('change', renderProducts);

        // Close modal when clicking outside
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

    <!-- Setup Instructions (remove after configuration) -->
    <div id="setupInstructions" style="position: fixed; bottom: 20px; left: 20px; background: rgba(248, 246, 240, 0.95); padding: 20px; border-radius: 15px; max-width: 400px; font-size: 0.9rem; color: #5d4e37; z-index: 1001; display: none;">
        <h4 style="margin-bottom: 10px;">🔧 Setup Required</h4>
        <p style="margin-bottom: 10px;">To use this app, you need to:</p>
        <ol style="margin-left: 20px; margin-bottom: 15px;">
            <li>Create a Firebase project at <a href="https://console.firebase.google.com" target="_blank" style="color: #6b5b73;">console.firebase.google.com</a></li>
            <li>Enable Authentication (Google sign-in)</li>
            <li>Enable Firestore Database</li>
            <li>Replace the Firebase config in the code</li>
        </ol>
        <button onclick="this.parentElement.style.display='none'" style="background: #8b7d6b; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">got it</button>
    </div>

    <script>
        // Show setup instructions if Firebase config is not set
        if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
            document.getElementById('setupInstructions').style.display = 'block';
        }
    </script>
</body>
</html>
